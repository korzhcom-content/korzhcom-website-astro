---
import PageLayout from "./PageLayout.astro"
import TableOfContents from "../components/TOC.astro"
import {Image} from "astro:assets"
import {formatDate} from "../js/utils.js";
import {slugify} from "../js/utils";
import PostLinks from "../components/PostLinks.astro";
const { frontmatter, headings } = Astro.props
const { title, date, author, description, image, draft, category, tags, time = '1 min'} = frontmatter
const allPosts = await Astro.glob('/src/pages/blog/**/*.md')
const relatedPosts = allPosts.filter((p)=> p.frontmatter.category === category).filter(p=>p.frontmatter.title !== title)
const recentPosts = allPosts.sort((a, b)=>Date.parse(b.frontmatter.date) - Date.parse(a.frontmatter.date)).slice(0, 5).filter(p=>p.frontmatter.title !== title)
---
<PageLayout>
    <hr class="w-100 mt-4"/>
    <section class="container-fluid mb-4">
        <div class="container pl-0 pr-0">

            <div class="row mt-4">
                <div class="cell-md-9">
                    <div class="pr-10">
                        <h1 class="text-bold">{title}</h1>
                        <div class="mb-4 text-muted reduce-1 d-flex flex-row">
                            <span>Category: </span><a class="ml-2" href=`/category/${slugify(category)}`>{category}</a>
                            <div class="ml-auto">{formatDate(date)} &bull; {time && `${time} read`}</div>
                        </div>

                        <Image class="blog-image"
                               src={image.url}
                               alt={image.alt}
                               format="avif"
                               width="300"
                               height="100"
                        />

                        <div class="post-content mt-4">
                            <div class="content">
                                <slot/>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="cell-md-3">
                    <div class="sidebar border-left bd-default pl-4 pr-4">
                        <div>
                            <div class="text-bold enlarge-1 border-bottom bd-default">Table of Contents</div>
                            <TableOfContents headings={headings} />
                        </div>
                        <div class="mt-6">
                            <div class="text-bold border-bottom bd-default">Related posts</div>
                            {
                                relatedPosts.length === 0 ? <div class="reduce-1 text-muted">No posts</div> : <PostLinks posts={relatedPosts}/>
                            }
                        </div>
                        <div class="mt-6">
                            <div class="text-bold border-bottom bd-default">Recent posts</div>
                            {
                                recentPosts.length === 0 ? <div class="reduce-1 text-muted">No posts</div> : <PostLinks posts={recentPosts}/>
                            }
                        </div>
                        <div class="mt-6">
                            <div class="text-bold border-bottom bd-default">Tags</div>
                            <div class="mt-1">
                                {tags && tags.map(tag => <a class="tag" href=`/tags/${tag}`>{tag}</a>)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</PageLayout>

<style lang="less">
    .blog-image {
        max-height: 400px;
        object-fit: cover;
    }
    .app-bar {
        border-bottom: 1px solid #a6a6a6 !important;
    }
</style>